{% extends "base.html" %}

{% block title %}Administra√ß√£o - Servi√ßos{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">In√≠cio</a></li>
                <li class="breadcrumb-item active">Administra√ß√£o de Servi√ßos</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3>üîß Gerenciamento de Servi√ßos</h3>
            </div>
            <div class="card-body">
                <p class="lead">Servi√ßos s√£o carregados sob demanda para otimizar performance e mem√≥ria.</p>
                
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Servi√ßo</th>
                            <th>Status</th>
                            <th>Lazy</th>
                            <th>Carregado</th>
                            <th>Chamadas</th>
                            <th>Tempo de carga</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for name, info in status.items() %}
                        <tr>
                            <td><strong>{{ name }}</strong></td>
                            <td>
                                {% if info.loaded %}
                                <span class="badge bg-success">Ativo</span>
                                {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                                {% endif %}
                            </td>
                            <td>{{ "Sim" if info.lazy else "N√£o" }}</td>
                            <td>{{ "Sim" if info.loaded else "N√£o" }}</td>
                            <td>{{ info.calls }}</td>
                            <td>
                                {% if info.load_time %}
                                {{ "%.2f"|format(info.load_time) }}s
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if info.loaded %}
                                <button class="btn btn-sm btn-warning" onclick="clearCache('{{ name }}')">
                                    üßπ Limpar cache
                                </button>
                                {% endif %}
                                
                                {% if name == 'spacy' and not info.loaded %}
                                <button class="btn btn-sm btn-info" onclick="preloadSpacy('ru')">
                                    üá∑üá∫ Pr√©-carregar russo
                                </button>
                                <button class="btn btn-sm btn-info" onclick="preloadSpacy('en')">
                                    üá∫üá∏ Pr√©-carregar ingl√™s
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function clearCache(service) {
    fetch(`/admin/services/${service}/clear-cache`, {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        alert(`Cache limpo: ${data.message}`);
        location.reload();
    });
}

function preloadSpacy(lang) {
    fetch(`/admin/services/spacy/preload?lang=${lang}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Modelo ${lang} pr√©-carregado com sucesso!`);
        } else {
            alert(`Falha ao pr√©-carregar ${lang}`);
        }
        location.reload();
    });
}
</script>
{% endblock %}