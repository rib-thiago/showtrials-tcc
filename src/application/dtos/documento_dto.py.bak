# src/application/dtos/documento_dto.py
"""
Data Transfer Objects para Documento.
Separamos o que vai para UI do que fica no dom√≠nio.
"""

from dataclasses import dataclass, field
from typing import Dict, List, Optional

from src.domain.value_objects.nome_russo import NomeRusso
from src.domain.value_objects.tipo_documento import TipoDocumento


@dataclass
class DocumentoDTO:
    """
    DTO completo para exibi√ß√£o de um documento.
    Cont√©m apenas dados necess√°rios para a UI.
    """

    id: Optional[int]
    centro: str
    titulo: str
    data_original: Optional[str]
    url: str
    texto: str
    data_coleta: str  # ISO format

    # Metadados enriquecidos
    tipo: Optional[str]
    tipo_descricao: Optional[str]
    tipo_icone: Optional[str]
    pessoa_principal: Optional[str]
    pessoa_principal_en: Optional[str]
    remetente: Optional[str]
    destinatario: Optional[str]
    envolvidos: List[str] = field(default_factory=list)
    tem_anexos: bool = False

    # M√©tricas
    tamanho_caracteres: int = 0
    tamanho_palavras: int = 0

    # Tradu√ß√µes
    traducoes: List[Dict] = field(default_factory=list)

    @classmethod
    def from_domain(cls, documento, tradutor_nomes=None, traducoes=None):
        """
        Converte entidade Documento para DTO.

        Args:
            documento: Entidade Documento do dom√≠nio
            tradutor_nomes: Fun√ß√£o opcional para traduzir nomes
            traducoes: Lista opcional de tradu√ß√µes do documento
        """
        # Traduzir pessoa principal se houver tradutor
        pessoa_en = None
        if tradutor_nomes and documento.pessoa_principal:
            try:
                nome = NomeRusso(documento.pessoa_principal)
                pessoa_en = nome.transliterar()
            except:
                pessoa_en = documento.pessoa_principal

        # Calcular palavras (aproximado)
        palavras = len(documento.texto.split()) if documento.texto else 0

        return cls(
            id=documento.id,
            centro=documento.centro,
            titulo=documento.titulo,
            data_original=documento.data_original,
            url=documento.url,
            texto=documento.texto,
            data_coleta=documento.data_coleta.isoformat() if documento.data_coleta else None,
            tipo=documento.tipo,
            tipo_descricao=documento.tipo_descricao,
            tipo_icone=TipoDocumento(documento.tipo).icone if documento.tipo else "üìÑ",
            pessoa_principal=documento.pessoa_principal,
            pessoa_principal_en=pessoa_en,
            remetente=documento.remetente,
            destinatario=documento.destinatario,
            envolvidos=documento.envolvidos or [],
            tem_anexos=documento.tem_anexos,
            tamanho_caracteres=documento.tamanho_caracteres,
            tamanho_palavras=palavras,
            traducoes=traducoes or [],
        )


@dataclass
class DocumentoListaDTO:
    """
    DTO resumido para listagens.
    Mais leve que o DTO completo.
    """

    id: int
    centro: str
    titulo: str
    data_original: Optional[str]
    tipo: Optional[str]
    tipo_icone: str
    tipo_descricao: Optional[str]
    pessoa_principal: Optional[str]
    pessoa_principal_en: Optional[str]
    tem_traducao: bool = False
    tamanho: int = 0

    @classmethod
    def from_domain(cls, documento, tem_traducao=False, tradutor_nomes=None):
        """Converte entidade para DTO de listagem."""
        pessoa_en = None
        if tradutor_nomes and documento.pessoa_principal:
            try:
                nome = NomeRusso(documento.pessoa_principal)
                pessoa_en = nome.transliterar()
            except:
                pessoa_en = documento.pessoa_principal

        return cls(
            id=documento.id,
            centro=documento.centro,
            titulo=documento.titulo,
            data_original=documento.data_original,
            tipo=documento.tipo,
            tipo_icone=TipoDocumento(documento.tipo).icone if documento.tipo else "üìÑ",
            tipo_descricao=documento.tipo_descricao,
            pessoa_principal=documento.pessoa_principal,
            pessoa_principal_en=pessoa_en,
            tem_traducao=tem_traducao,
            tamanho=documento.tamanho_caracteres,
        )
